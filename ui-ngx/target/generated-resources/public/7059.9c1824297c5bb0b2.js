"use strict";(self.webpackChunkthingsboard=self.webpackChunkthingsboard||[]).push([[7059],{57059:(W,w,b)=>{b.r(w),b.d(w,{TbFlot:()=>E});var d=b(9351),T=b(50147),v=b(27552),k=b(93387),D=b(95500),H=b(32825),P=b(71337),x=b(70970);const F=v;class E{constructor(t,s){this.ctx=t,this.chartType=s,this.plotInited=!1,this.isMouseInteraction=!1,this.flotHoverHandler=this.onFlotHover.bind(this),this.flotSelectHandler=this.onFlotSelect.bind(this),this.dblclickHandler=this.onFlotDblClick.bind(this),this.mousedownHandler=this.onFlotMouseDown.bind(this),this.mouseupHandler=this.onFlotMouseUp.bind(this),this.mouseleaveHandler=this.onFlotMouseLeave.bind(this),this.flotClickHandler=this.onFlotClick.bind(this),this.chartType=this.chartType||"line",this.settings=t.settings,this.utils=this.ctx.$injector.get(H.F),this.showTooltip=!(0,d.$K)(this.settings.showTooltip)||this.settings.showTooltip,this.tooltip=this.showTooltip?x("#flot-series-tooltip"):null,0===this.tooltip?.length&&(this.tooltip=this.createTooltipElement()),this.trackDecimals=t.decimals,this.trackUnits=t.units,this.tooltipIndividual="pie"===this.chartType||!!(0,d.$K)(this.settings.tooltipIndividual)&&this.settings.tooltipIndividual,this.tooltipCumulative=!!(0,d.$K)(this.settings.tooltipCumulative)&&this.settings.tooltipCumulative,this.hideZeros=!!(0,d.$K)(this.settings.hideZeros)&&this.settings.hideZeros;const e={color:this.settings.fontColor||"#545454",size:this.settings.fontSize||10,family:"Roboto"};if(this.options={title:null,subtitile:null,shadowSize:(0,d.$K)(this.settings.shadowSize)?this.settings.shadowSize:4,HtmlText:!1,grid:{hoverable:!0,mouseActiveRadius:10,autoHighlight:!0===this.tooltipIndividual,markings:[]},legend:{show:!1}},"line"===this.chartType||"bar"===this.chartType||"state"===this.chartType){if(this.options.selection={mode:"x"},this.options.xaxes=[],this.xaxis={mode:"time",timezone:"browser",font:(0,d.I8)(e),labelFont:(0,d.I8)(e)},this.yaxis={font:(0,d.I8)(e),labelFont:(0,d.I8)(e)},this.settings.xaxis&&(this.xaxis.font.color=this.settings.xaxis.color||this.xaxis.font.color,this.xaxis.label=this.utils.customTranslation(this.settings.xaxis.title,this.settings.xaxis.title)||null,this.xaxis.labelFont.color=this.xaxis.font.color,this.xaxis.labelFont.size=this.xaxis.font.size+2,this.xaxis.labelFont.weight="bold"),this.yAxisTickFormatter=this.formatYAxisTicks.bind(this),this.yaxis.tickFormatter=this.yAxisTickFormatter,this.settings.yaxis&&(this.yaxis.font.color=this.settings.yaxis.color||this.yaxis.font.color,this.yaxis.min=(0,d.$K)(this.settings.yaxis.min)?this.settings.yaxis.min:null,this.yaxis.max=(0,d.$K)(this.settings.yaxis.max)?this.settings.yaxis.max:null,this.yaxis.label=this.utils.customTranslation(this.settings.yaxis.title,this.settings.yaxis.title)||null,this.yaxis.labelFont.color=this.yaxis.font.color,this.yaxis.labelFont.size=this.yaxis.font.size+2,this.yaxis.labelFont.weight="bold",(0,d.hj)(this.settings.yaxis.tickSize)?this.yaxis.tickSize=this.settings.yaxis.tickSize:this.yaxis.tickSize=null,(0,d.hj)(this.settings.yaxis.tickDecimals)?this.yaxis.tickDecimals=this.settings.yaxis.tickDecimals:this.yaxis.tickDecimals=null,this.settings.yaxis.ticksFormatter&&this.settings.yaxis.ticksFormatter.length))try{this.yaxis.ticksFormatterFunction=new Function("value",this.settings.yaxis.ticksFormatter)}catch{this.yaxis.ticksFormatterFunction=null}this.options.grid.borderWidth=1,this.options.grid.color=this.settings.fontColor||"#545454",this.settings.grid&&(this.options.grid.color=this.settings.grid.color||"#545454",this.options.grid.backgroundColor=this.settings.grid.backgroundColor||null,this.options.grid.tickColor=this.settings.grid.tickColor||"#DDDDDD",this.options.grid.borderWidth=(0,d.$K)(this.settings.grid.outlineWidth)?this.settings.grid.outlineWidth:1,!1===this.settings.grid.verticalLines&&(this.xaxis.tickLength=0),!1===this.settings.grid.horizontalLines&&(this.yaxis.tickLength=0),(0,d.$K)(this.settings.grid.margin)&&(this.options.grid.margin=this.settings.grid.margin),(0,d.$K)(this.settings.grid.minBorderMargin)&&(this.options.grid.minBorderMargin=this.settings.grid.minBorderMargin)),this.options.xaxes[0]=(0,d.I8)(this.xaxis),this.settings.xaxis&&!1===this.settings.xaxis.showLabels&&(this.options.xaxes[0].tickFormatter=()=>""),this.options.series={},this.options.crosshair={mode:"x"},"line"===this.chartType&&this.settings.smoothLines&&(this.options.series.curvedLines={active:!0,monotonicFit:!0}),("line"===this.chartType||"bar"===this.chartType)&&isFinite(this.settings.thresholdsLineWidth)&&(this.options.grid.markingsLineWidth=this.settings.thresholdsLineWidth),"bar"===this.chartType&&(this.options.series.lines={show:!1,fill:!1,steps:!1},this.options.series.bars={show:!0,lineWidth:0,fill:.9,align:this.settings.barAlignment||"left"},this.defaultBarWidth=this.settings.defaultBarWidth||600),"state"===this.chartType&&(this.options.series.lines={steps:!0,show:!0})}else"pie"===this.chartType&&(this.options.series={pie:{show:!0,label:{show:!0===this.settings.showLabels},radius:this.settings.radius||1,innerRadius:this.settings.innerRadius||0,stroke:{color:"#fff",width:0},tilt:this.settings.tilt||1,shadow:{left:5,top:15,alpha:.02}}},this.options.grid.clickable=!0,this.settings.stroke&&(this.options.series.pie.stroke.color=this.settings.stroke.color||"#fff",this.options.series.pie.stroke.width=this.settings.stroke.width||0,this.options.series.pie.stroke.width&&this.scalingPieRadius()),this.options.series.pie.label.show&&(this.options.series.pie.label.formatter=(i,a)=>`<div class='pie-label'>${a.dataKey.label}<br/>${Math.round(a.percent)}%</div>`,this.options.series.pie.label.radius=3/4,this.options.series.pie.label.background={opacity:.8}),this.animatedPie=!0===this.settings.animatedPie);this.ctx.defaultSubscription&&this.init(this.ctx.$container,this.ctx.defaultSubscription)}init(t,s){if(this.$element=t,this.$element.css("letter-spacing","normal"),this.subscription=s,this.comparisonEnabled=this.subscription?this.subscription.comparisonEnabled:this.settings.comparisonEnabled,this.comparisonEnabled){const o=(0,d.I8)(this.xaxis);o.position="top",this.settings.xaxisSecond&&(!1===this.settings.xaxisSecond.showLabels&&(o.tickFormatter=()=>""),o.label=this.utils.customTranslation(this.settings.xaxisSecond.title,this.settings.xaxisSecond.title)||null,o.position=this.settings.xaxisSecond.axisPosition),o.tickLength=0,this.options.xaxes.push(o),this.options.series.stack=!1}else this.options.series.stack=!0===this.settings.stack;const e=[];this.yaxes=[];const i={},a=[],l=[];if(this.settings.customLegendEnabled&&this.settings.dataKeysListForLabels?.length){this.labelPatternsSourcesData=[];const o=[];this.settings.dataKeysListForLabels.forEach(n=>{n.settings={}}),this.subscription.datasources.forEach(n=>{const r={type:n.type,entityType:n.entityType,entityId:n.entityId,dataKeys:this.settings.dataKeysListForLabels};o.push(r)}),this.subscribeForLabelPatternsSources(o)}let h=null;if(this.settings.tooltipValueFormatter&&this.settings.tooltipValueFormatter.length)try{h=new Function("value","latestData",this.settings.tooltipValueFormatter)}catch{h=null}for(let o=0;o<this.subscription.data.length;o++){const n=this.subscription.data[o];e.push(n.dataKey.color);const r=n.dataKey.settings;if(n.dataKey.tooltipValueFormatFunction=h,r.tooltipValueFormatter&&r.tooltipValueFormatter.length)try{n.dataKey.tooltipValueFormatFunction=new Function("value","latestData",r.tooltipValueFormatter)}catch{n.dataKey.tooltipValueFormatFunction=h}if(n.lines={fill:!0===r.fillLines&&(r.fillLinesOpacity||.4)},this.settings.stack&&!this.comparisonEnabled?n.stack=!r.excludeFromStacking:n.stack=!1,"line"===this.chartType||"state"===this.chartType?n.lines.show=!1!==r.showLines:n.lines.show=!0===r.showLines,(0,d.$K)(r.lineWidth)&&null!==r.lineWidth&&(n.lines.lineWidth=r.lineWidth),n.points={show:!1,radius:8},!0===r.showPoints&&(n.points.show=!0,n.points.lineWidth=(0,d.$K)(r.showPointsLineWidth)?r.showPointsLineWidth:5,n.points.radius=(0,d.$K)(r.showPointsRadius)?r.showPointsRadius:3,n.points.symbol=(0,d.$K)(r.showPointShape)?r.showPointShape:"circle","custom"===n.points.symbol&&r.pointShapeFormatter))try{n.points.symbol=new Function("ctx, x, y, radius, shadow",r.pointShapeFormatter)}catch{n.points.symbol="circle"}"line"===this.chartType&&this.settings.smoothLines&&!n.points.show&&(n.curvedLines={apply:!0});const f=(0,k.Z)(n.dataKey.color);if(f.setAlpha(.75),n.highlightColor=f.toRgbString(),n.datasource.isAdditional?(n.xaxisIndex=1,n.xaxis=2):(n.xaxisIndex=0,n.xaxis=1),this.yaxis){const p=n.dataKey.units&&n.dataKey.units.length?n.dataKey.units:this.trackUnits;let u;if(r.showSeparateAxis?(u=this.createYAxis(r,p),this.yaxes.push(u)):(u=i[p],u||(u=this.createYAxis(r,p),i[p]=u,this.yaxes.push(u))),n.yaxisIndex=this.yaxes.indexOf(u),n.yaxis=n.yaxisIndex+1,u.keysInfo[o]={hidden:!1},u.show=!0,r.thresholds&&r.thresholds.length)for(const c of r.thresholds)if("predefinedValue"===c.thresholdValueSource&&isFinite(c.thresholdValue)){const g=this.subscription.data.length+a.length,m=this.generateThreshold(a,n.yaxis,c.lineWidth,c.color,g,c.thresholdValue);null!=m&&a.push(m)}else if(c.thresholdEntityAlias&&c.thresholdAttribute){const g=this.ctx.aliasController.getEntityAliasId(c.thresholdEntityAlias);if(!g)continue;let m=l.filter(I=>I.entityAliasId===g)[0];const y={type:P.dG.attribute,name:c.thresholdAttribute,label:c.thresholdAttribute,settings:{yaxis:n.yaxis,lineWidth:c.lineWidth,color:c.color},_hash:Math.random()};m?m.dataKeys.push(y):(m={type:T.i9.entity,name:c.thresholdEntityAlias,aliasName:c.thresholdEntityAlias,entityAliasId:g,dataKeys:[y]},l.push(m))}}this.labelPatternsSourcesData?.length&&this.substituteLabelPatterns(n,o)}if(this.subscribeForThresholdsAttributes(l),this.predefinedThresholds=a,this.options.colors=e,this.options.yaxes=(0,d.I8)(this.yaxes),"line"===this.chartType||"bar"===this.chartType||"state"===this.chartType){"bar"===this.chartType&&(this.subscription.timeWindowConfig.aggregation&&this.subscription.timeWindowConfig.aggregation.type===D.Eu.NONE?this.options.series.bars.barWidth=this.defaultBarWidth:this.options.series.bars.barWidth=.6*this.subscription.timeWindow.interval),this.options.xaxes[0].min=this.subscription.timeWindow.minTime,this.options.xaxes[0].max=this.subscription.timeWindow.maxTime,this.comparisonEnabled&&(this.options.xaxes[1].min=this.subscription.comparisonTimeWindow.minTime,this.options.xaxes[1].max=this.subscription.comparisonTimeWindow.maxTime);let o=(0,d.I8)(this.predefinedThresholds);this.attributesThresholds&&(o=o.concat(this.attributesThresholds)),this.latestDataThresholds=this.thresholdsSourcesDataUpdated(o,this.subscription.latestData,!0),this.options.grid.markings=o.concat(this.latestDataThresholds),this.subscription.latestData?this.latestData=(0,d.uM)(this.subscription.latestData):this.latestData=[]}else"pie"===this.chartType&&(this.latestData=(0,d.uM)(this.subscription.data));if(this.checkMouseEvents(),this.plot&&this.plot.destroy(),"pie"===this.chartType&&this.animatedPie){this.pieDataAnimationDuration=250,this.pieData=(0,d.I8)(this.subscription.data),this.pieRenderedData=[],this.pieTargetData=[];for(let o=0;o<this.subscription.data.length;o++)this.pieTargetData[o]=this.subscription.data[o].data&&this.subscription.data[o].data[0]?this.subscription.data[o].data[0][1]:0;this.pieDataRendered()}this.plotInited=!0,this.createPlot()}update(){if(this.updateTimeoutHandle&&(clearTimeout(this.updateTimeoutHandle),this.updateTimeoutHandle=null),this.subscription)if(!this.isMouseInteraction&&this.plot)if("line"===this.chartType||"bar"===this.chartType||"state"===this.chartType){let t=!1;if(this.yaxis){for(let s=0;s<this.subscription.data.length;s++){const e=this.subscription.data[s],i=e.yaxisIndex;this.yaxes[i].keysInfo[s].hidden!==e.dataKey.hidden&&(this.yaxes[i].keysInfo[s].hidden=e.dataKey.hidden,t=!0),this.labelPatternsSourcesData?.length&&this.substituteLabelPatterns(e,s)}t&&(this.options.yaxes.length=0,this.yaxes.forEach(s=>{let e=!0;s.keysInfo.forEach(a=>{a&&(e=e&&a.hidden)}),s.hidden=e;let i=1;s.hidden||(this.options.yaxes.push(s),i=this.options.yaxes.length);for(let a=0;a<s.keysInfo.length;a++)s.keysInfo[a]&&(this.subscription.data[a].yaxis=i)}),this.options.yaxis={show:!!this.options.yaxes.length})}this.options.xaxes[0].min=this.subscription.timeWindow.minTime,this.options.xaxes[0].max=this.subscription.timeWindow.maxTime,this.comparisonEnabled&&(this.options.xaxes[1].min=this.subscription.comparisonTimeWindow.minTime,this.options.xaxes[1].max=this.subscription.comparisonTimeWindow.maxTime),"bar"===this.chartType&&(this.subscription.timeWindowConfig.aggregation&&this.subscription.timeWindowConfig.aggregation.type===D.Eu.NONE?this.options.series.bars.barWidth=this.defaultBarWidth:this.options.series.bars.barWidth=.6*this.subscription.timeWindow.interval),t?this.redrawPlot():(this.plot.getOptions().xaxes[0].min=this.subscription.timeWindow.minTime,this.plot.getOptions().xaxes[0].max=this.subscription.timeWindow.maxTime,this.comparisonEnabled&&(this.plot.getOptions().xaxes[1].min=this.subscription.comparisonTimeWindow.minTime,this.plot.getOptions().xaxes[1].max=this.subscription.comparisonTimeWindow.maxTime),"bar"===this.chartType&&(this.subscription.timeWindowConfig.aggregation&&this.subscription.timeWindowConfig.aggregation.type===D.Eu.NONE?this.plot.getOptions().series.bars.barWidth=this.defaultBarWidth:this.plot.getOptions().series.bars.barWidth=.6*this.subscription.timeWindow.interval),this.updateData())}else"pie"===this.chartType&&(this.latestData=(0,d.uM)(this.subscription.data),this.animatedPie?this.nextPieDataAnimation(!0):this.updateData());else this.isMouseInteraction&&this.plot&&(this.updateTimeoutHandle=setTimeout(this.update.bind(this),30))}latestDataUpdate(){if(this.latestUpdateTimeoutHandle&&(clearTimeout(this.latestUpdateTimeoutHandle),this.latestUpdateTimeoutHandle=null),this.subscription)if(!this.isMouseInteraction&&this.plot){if("line"===this.chartType||"bar"===this.chartType||"state"===this.chartType){let t=(0,d.I8)(this.predefinedThresholds);this.attributesThresholds&&(t=t.concat(this.attributesThresholds)),this.latestDataThresholds=this.thresholdsSourcesDataUpdated(t,this.subscription.latestData,!0),this.options.grid.markings=t.concat(this.latestDataThresholds),this.plot&&(this.plot.getOptions().grid.markings=this.options.grid.markings,this.updateData()),this.subscription.latestData?this.latestData=(0,d.uM)(this.subscription.latestData):this.latestData=[]}}else this.isMouseInteraction&&this.plot&&(this.latestUpdateTimeoutHandle=setTimeout(this.latestDataUpdate.bind(this),30))}latestDataByDataIndex(t){return this.latestData[t]?this.latestData[t]:{}}scalingPieRadius(){let t;t=this.ctx.width>this.ctx.height?this.ctx.height:this.ctx.width;const s=this.options.series.pie.stroke.width/t;this.options.series.pie.radius=s<1?this.settings.radius-s:0}resize(){if(this.resizeTimeoutHandle&&(clearTimeout(this.resizeTimeoutHandle),this.resizeTimeoutHandle=null),this.plot&&this.plotInited)if("pie"===this.chartType&&this.settings.stroke?.width)this.scalingPieRadius(),this.redrawPlot();else{const t=this.$element.width(),s=this.$element.height();t&&s?(this.plot.resize(),"pie"!==this.chartType&&this.plot.setupGrid(),this.plot.draw()):this.resizeTimeoutHandle=setTimeout(this.resize.bind(this),30)}}checkMouseEvents(){const t=!this.ctx.isEdit;((0,d.o8)(this.mouseEventsEnabled)||this.mouseEventsEnabled!==t)&&(this.mouseEventsEnabled=t,this.$element&&(t?this.enableMouseEvents():this.disableMouseEvents(),this.redrawPlot()))}destroy(){this.cleanup(),this.tooltip&&(this.tooltip.stop(!0),this.tooltip.hide()),this.plot&&(this.plot.destroy(),this.plot=null,this.plotInited=!1)}cleanup(){this.updateTimeoutHandle&&(clearTimeout(this.updateTimeoutHandle),this.updateTimeoutHandle=null),this.latestUpdateTimeoutHandle&&(clearTimeout(this.latestUpdateTimeoutHandle),this.latestUpdateTimeoutHandle=null),this.createPlotTimeoutHandle&&(clearTimeout(this.createPlotTimeoutHandle),this.createPlotTimeoutHandle=null),this.resizeTimeoutHandle&&(clearTimeout(this.resizeTimeoutHandle),this.resizeTimeoutHandle=null)}createPlot(){if(this.createPlotTimeoutHandle&&(clearTimeout(this.createPlotTimeoutHandle),this.createPlotTimeoutHandle=null),this.plotInited&&!this.plot){const t=this.$element.width(),s=this.$element.height();t&&s?"pie"===this.chartType&&this.animatedPie?this.plot=x.plot(this.$element,this.pieData,this.options):this.plot=x.plot(this.$element,this.subscription.data,this.options):this.createPlotTimeoutHandle=setTimeout(this.createPlot.bind(this),30)}}updateData(){this.plot.setData(this.subscription.data),"pie"!==this.chartType&&this.plot.setupGrid(),this.plot.draw()}redrawPlot(){this.plot&&this.plotInited&&(this.plot.destroy(),this.plot=null,this.createPlot())}createYAxis(t,s){const e=(0,d.I8)(this.yaxis);let i,a;const l=t.axisTitle&&t.axisTitle.length?t.axisTitle:e.label;i=(0,d.hj)(t.axisTickDecimals)?t.axisTickDecimals:e.tickDecimals,a=(0,d.hj)(t.axisTickSize)?t.axisTickSize:e.tickSize;const h=t.axisPosition&&t.axisPosition.length?t.axisPosition:"left",o=(0,d.$K)(t.axisMin)?t.axisMin:e.min,n=(0,d.$K)(t.axisMax)?t.axisMax:e.max;if(e.label=l,e.min=o,e.max=n,e.tickUnits=s,e.tickDecimals=i,e.tickSize=a,e.alignTicksWithAxis="right"===h&&null===a?1:null,e.position=h,e.keysInfo=[],t.axisTicksFormatter&&t.axisTicksFormatter.length)try{e.ticksFormatterFunction=new Function("value",t.axisTicksFormatter)}catch{e.ticksFormatterFunction=this.yaxis.ticksFormatterFunction}return e}subscribeForThresholdsAttributes(t){const s={datasources:t,useDashboardTimewindow:!1,type:T.oS.latest,callbacks:{onDataUpdated:e=>{let i=(0,d.I8)(this.predefinedThresholds);this.latestDataThresholds&&(i=i.concat(this.latestDataThresholds)),this.attributesThresholds=this.thresholdsSourcesDataUpdated(i,e.data),this.options.grid.markings=i.concat(this.attributesThresholds),this.plot&&(this.plot.getOptions().grid.markings=this.options.grid.markings,this.updateData())}}};this.ctx.subscriptionApi.createSubscription(s,!0).subscribe(e=>{this.thresholdsSourcesSubscription=e})}thresholdsSourcesDataUpdated(t,s,e=!1){const i=[];return s.forEach(a=>{(!e||a.dataKey.settings.useAsThreshold)&&a&&a.data&&a.data[0]&&this.parseThresholdData(a.data[0][1]).forEach(o=>{const n=this.processSingleDataValue(o,a,a.dataKey.settings,t,e);null!=n&&i.push(n)})}),i}parseThresholdData(t){let s;try{const e=JSON.parse(t);s=Array.isArray(e)?e:[e]}catch{s=[t]}return s}processSingleDataValue(t,s,e,i,a=!1){if((0,d.kE)(t)&&isFinite(t)){let l,h,o;if(a)l=1,h=e.thresholdLineWidth,o=e.thresholdColor||s.dataKey.color;else{const r=s.dataKey.settings;l=r.yaxis,h=r.lineWidth,o=r.color||s.dataKey.color}const n=this.subscription.data.length+i.length;return this.generateThreshold(i,l,h,o,n,t)}}generateThreshold(t,s,e,i,a,l){const h={};let o;return o=(0,d.$K)(s)&&1!==s?"y"+s+"axis":"yaxis",isFinite(e)&&(h.lineWidth=e),(0,d.$K)(i)?h.color=i:h.color=this.utils.getMaterialColor(a),h[o]={from:l,to:l},t.filter(r=>(0,d.Xy)(r[o],h[o])).length?null:h}subscribeForLabelPatternsSources(t){const s={datasources:t,useDashboardTimewindow:!1,type:T.oS.latest,callbacks:{onDataUpdated:e=>{this.labelPatternsParamsDataUpdated(e.data)}}};this.ctx.subscriptionApi.createSubscription(s,!0).subscribe(e=>{this.labelPatternsSourcesSubscription=e})}labelPatternsParamsDataUpdated(t){this.labelPatternsSourcesData=t;for(let s=0;s<this.subscription.data.length;s++){const e=this.subscription.data[s];this.substituteLabelPatterns(e,s)}this.updateData(),this.ctx.detectChanges()}substituteLabelPatterns(t,s){const e=this.labelPatternsSourcesData.filter(a=>a.datasource.entityId===t.datasource.entityId);let i=(0,d.mZ)(t.datasource,t.dataKey.pattern);if(e.forEach(a=>{if(a&&a.data&&a.data[0]){const l=a.data[0][1],h=a.dataKey.name;(0,d.$K)(l)&&null!==l&&(i=(0,d.Wh)(i,h,l))}}),(0,d.$K)(this.subscription.legendData)){const a=this.subscription.legendData.keys.findIndex(l=>l.dataIndex===s);-1!==a&&(this.subscription.legendData.keys[a].dataKey.label=i)}t.dataKey.label=i}seriesInfoDiv(t,s,e,i,a,l,h,o,n){const r=x("<div></div>");r.css({display:"flex",alignItems:"center",justifyContent:"space-between"});const f=x("<span></span>");f.css({backgroundColor:s,width:"20px",height:"3px",display:"inline-block",verticalAlign:"middle",marginRight:"5px"}),r.append(f);const p=x(`<span>${t}:</span>`);let u;p.css({marginRight:"10px"}),l&&p.css({color:"#FFF",fontWeight:"700"}),r.append(p),u=n?n(e,this.latestDataByDataIndex(o)):this.ctx.utils.formatValue(e,a,i),(0,d.hj)(h)&&(u+=" ("+Math.round(h)+" %)");const c=x(`<span>${u}</span>`);return c.css({marginLeft:"auto",fontWeight:"700"}),l&&c.css({color:"#FFF"}),r.append(c),r}seriesInfoDivFromInfo(t,s){const e=t.units&&t.units.length?t.units:this.trackUnits,i=(0,d.nu)(t.decimals)?t.decimals:this.trackDecimals;return this.seriesInfoDiv(t.label,t.color,t.value,e,i,t.index===s,null,t.index,t.tooltipValueFormatFunction).prop("outerHTML")}createTooltipElement(){const t=x('<div id="flot-series-tooltip" class="flot-mouse-value"></div>');return t.css({fontSize:"12px",fontFamily:"Roboto",fontWeight:"300",lineHeight:"18px",opacity:"1",backgroundColor:"rgba(0,0,0,0.7)",color:"#D9DADB",position:"absolute",display:"none",zIndex:"1100",padding:"4px 10px",borderRadius:"4px"}).appendTo("body"),t}formatPieTooltip(t){const s=t.series.dataKey.units&&t.series.dataKey.units.length?t.series.dataKey.units:this.trackUnits,e=(0,d.nu)(t.series.dataKey.decimals)?t.series.dataKey.decimals:this.trackDecimals;return this.seriesInfoDiv(t.series.dataKey.label,t.series.dataKey.color,t.datapoint[1][0][1],s,e,!0,t.series.percent,0,t.series.dataKey.tooltipValueFormatFunction).prop("outerHTML")}formatChartTooltip(t,s){let e="";if(this.tooltipIndividual){let i;i=t[1]&&t[1].seriesHover.length?t[0].seriesHover.concat(t[1].seriesHover):t[0].seriesHover;const a=i.filter(l=>l.index===s);if(a&&a.length){const l=parseInt(a[0].time,10),h=F(l).format("YYYY-MM-DD HH:mm:ss"),o=x("<div>"+h+"</div>");o.css({display:"flex",alignItems:"center",justifyContent:"center",padding:"4px",fontWeight:"700"}),e+=o.prop("outerHTML"),e+=this.seriesInfoDivFromInfo(a[0],s)}}else{let i;i=t[1]&&t[1].seriesHover.length?5:15;let a=0;a=t[1]&&t[1].seriesHover.length>t[0].seriesHover.length?Math.ceil(t[1].seriesHover.length/i):Math.ceil(t[0].seriesHover.length/i),t.forEach(l=>{if((0,d.hj)(l.time)){let h="";const o=parseInt(l.time,10),n=F(o).format("YYYY-MM-DD HH:mm:ss"),r=x("<div>"+n+"</div>");r.css({display:"flex",alignItems:"center",justifyContent:"center",padding:"4px",fontWeight:"700"}),e+=r.prop("outerHTML");const f=x("<div></div>");f.css({display:"flex",flexDirection:"row"});for(let p=0;p<a;p++){const u=x("<div></div>");u.css({display:"flex",flexDirection:"column",flex:"1"});let c="";for(let g=p*i;g<(p+1)*i&&!(g>=l.seriesHover.length);g++){const m=l.seriesHover[g];c+=this.seriesInfoDivFromInfo(m,s)}u.html(c),c&&(p>0&&(h+='<span style="min-width: 20px;"></span>'),h+=u.prop("outerHTML"))}f.html(h),e+=f.prop("outerHTML")}})}return e}formatYAxisTicks(t,s){if(this.settings.yaxis&&!1===this.settings.yaxis.showLabels)return"";if(s.options.ticksFormatterFunction)return s.options.ticksFormatterFunction(t);const e=s.options.tickDecimals?Math.pow(10,s.options.tickDecimals):1;let i=""+Math.round(t*e)/e;if((0,d.$K)(s.options.tickDecimals)&&null!==s.options.tickDecimals){const a=i.indexOf("."),l=-1===a?0:i.length-a-1;l<s.options.tickDecimals&&(i=(l?i:i+".")+(""+e).substr(1,s.options.tickDecimals-l))}return s.options.tickUnits&&(i+=" "+s.options.tickUnits),i}enableMouseEvents(){this.$element.css("pointer-events",""),this.$element.addClass("mouse-events"),"pie"!==this.chartType&&(this.options.selection={mode:"x"},this.$element.bind("plotselected",this.flotSelectHandler),this.$element.bind("dblclick",this.dblclickHandler)),this.$element.bind("plothover",this.flotHoverHandler),this.$element.bind("mousedown",this.mousedownHandler),this.$element.bind("mouseup",this.mouseupHandler),this.$element.bind("mouseleave",this.mouseleaveHandler),this.$element.bind("plotclick",this.flotClickHandler)}disableMouseEvents(){this.$element.css("pointer-events","none"),this.$element.removeClass("mouse-events"),"pie"!==this.chartType&&(this.options.selection={mode:null},this.$element.unbind("plotselected",this.flotSelectHandler),this.$element.unbind("dblclick",this.dblclickHandler)),this.$element.unbind("plothover",this.flotHoverHandler),this.$element.unbind("mousedown",this.mousedownHandler),this.$element.unbind("mouseup",this.mouseupHandler),this.$element.unbind("mouseleave",this.mouseleaveHandler),this.$element.unbind("plotclick",this.flotClickHandler)}onFlotHover(t,s,e){if(this.plot&&this.tooltip)if(this.tooltipIndividual&&!e||this.ctx.isEdit)this.tooltip.stop(!0),this.tooltip.hide(),this.plot.unhighlight();else{const i=!this.tooltipIndividual;i&&this.plot.unhighlight();const a=s.pageX,l=s.pageY;let h,o;if("pie"===this.chartType?h=this.formatPieTooltip(e):(o=this.getHoverInfo(this.plot.getData(),s),((0,d.hj)(o[0].time)||o[1]&&(0,d.hj)(o[1].time))&&(o[0].seriesHover.sort((n,r)=>r.value-n.value),o[1]&&o[1].seriesHover.length&&o[1].seriesHover.sort((n,r)=>r.value-n.value),h=this.formatChartTooltip(o,e?e.seriesIndex:-1))),h){this.tooltip.html(h).css({top:0,left:0}).fadeIn(200);const n=x(window).width(),r=x(window).height(),f=this.tooltip.width(),p=this.tooltip.height();let u=a+5,c=l+5;n-a<f+50&&(u=a-f-10),r-l<p+20&&(c=l-p-10),this.tooltip.css({top:c,left:u}),i&&o.forEach(g=>{g.seriesHover.forEach(m=>{this.plot.highlight(m.index,m.hoverIndex)})})}}}onFlotSelect(t,s){this.plot&&(this.plot.clearSelection(),this.subscription.onUpdateTimewindow(s.xaxis.from,s.xaxis.to))}onFlotDblClick(){this.subscription.onResetTimewindow()}onFlotMouseDown(){this.isMouseInteraction=!0}onFlotMouseUp(){this.isMouseInteraction=!1}onFlotMouseLeave(){this.tooltip&&(this.tooltip.stop(!0),this.tooltip.hide(),this.plot&&this.plot.unhighlight(),this.isMouseInteraction=!1)}onFlotClick(t,s,e){this.plot&&this.onPieSliceClick(t,e)}getHoverInfo(t,s){let e,i,a,l,h,o,n,r,f,p,c,u=0,g=0;const m=[{seriesHover:[]}];for(this.comparisonEnabled&&m.push({seriesHover:[]}),"bar"===this.chartType&&"left"!==this.options.series.bars.align&&(g="center"===this.options.series.bars.align?this.options.series.bars.barWidth/2:this.options.series.bars.barWidth),e=0;e<t.length;e++){let y;i=t[e],y=i.datasource.isAdditional?s.x2:s.x,y+=g,a=this.findHoverIndexFromData(y,i),i.data[a]&&i.data[a][0]&&(l=y-i.data[a][0],o=i.data[a][0],i.datasource.isAdditional?(!c||l>=0&&(l<c||c<0)||l<0&&l>c)&&(c=l,r=o):(!h||l>=0&&(l<h||h<0)||l<0&&l>h)&&(h=l,n=o),i.stack?this.tooltipIndividual||!this.tooltipCumulative?p=i.data[a][1]:(u+=i.data[a][1],p=u):p=i.data[a][1],(i.stack||i.curvedLines&&i.curvedLines.apply)&&(a=this.findHoverIndexFromDataPoints(y,i,a)),(!this.hideZeros||p)&&(f={value:p,hoverIndex:a,color:i.dataKey.color,label:i.dataKey.label,units:i.dataKey.units,decimals:i.dataKey.decimals,tooltipValueFormatFunction:i.dataKey.tooltipValueFormatFunction,time:o,distance:l,index:e},i.datasource.isAdditional?m[1].seriesHover.push(f):m[0].seriesHover.push(f)))}return m[1]&&m[1].seriesHover.length&&(m[1].time=r),m[0].time=n,m}findHoverIndexFromData(t,s){let a,e=0,i=s.data.length-1;for(;;){if(e>i)return Math.max(i,0);if(a=Math.floor((e+i)/2),s.data[a][0]===t)return a;s.data[a][0]<t?e=a+1:i=a-1}}findHoverIndexFromDataPoints(t,s,e){const i=s.datapoints.pointsize,a=e*i,l=s.datapoints.points.length;let h;for(h=a;h<l;h+=i)if(!s.lines.steps&&null!=s.datapoints.points[a]&&null==s.datapoints.points[h]||s.datapoints.points[h]>t)return Math.max(h-i,0)/i;return h/i-1}pieDataRendered(){for(let t=0;t<this.pieTargetData.length;t++){const s=this.pieTargetData[t]?this.pieTargetData[t]:0;this.pieRenderedData[t]=s,this.pieData[t].data[0]||(this.pieData[t].data[0]=[0,0]),this.pieData[t].data[0][1]=s}}nextPieDataAnimation(t){if(t){this.finishPieDataAnimation(),this.pieAnimationStartTime=this.pieAnimationLastTime=Date.now();for(let s=0;s<this.subscription.data.length;s++)this.pieTargetData[s]=this.subscription.data[s].data&&this.subscription.data[s].data[0]?this.subscription.data[s].data[0][1]:0}this.pieAnimationCaf&&(this.pieAnimationCaf(),this.pieAnimationCaf=null),this.pieAnimationCaf=this.ctx.$scope.raf.raf(this.onPieDataAnimation.bind(this))}onPieDataAnimation(){const t=Date.now(),s=t-this.pieAnimationLastTime,e=(t-this.pieAnimationStartTime)/this.pieDataAnimationDuration;if(e>=1)this.finishPieDataAnimation();else{if(s>=40){for(let i=0;i<this.pieTargetData.length;i++){const a=this.pieRenderedData[i],h=a+(this.pieTargetData[i]-a)*e;this.pieData[i].data[0]||(this.pieData[i].data[0]=[0,0]),this.pieData[i].data[0][1]=h}this.plot.setData(this.pieData),this.plot.draw(),this.pieAnimationLastTime=t}this.nextPieDataAnimation(!1)}}finishPieDataAnimation(){this.pieDataRendered(),this.plot.setData(this.pieData),this.plot.draw()}onPieSliceClick(t,s){const e=this.ctx.actionsApi.getActionDescriptors("sliceClick");if(t&&e.length){t.stopPropagation();const i=this.ctx.actionsApi.getActiveEntityInfo(),a=i?i.entityId:null,l=i?i.entityName:null,h=i?i.entityLabel:null;this.ctx.actionsApi.handleWidgetAction(t,e[0],a,l,s,h)}}}}}]);